<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="imgs/payrus_icon.png">
  <title>Payment Bridge</title>
  
  <link rel="stylesheet" href="payrus.css">
  <link rel="stylesheet" href="dashboard.css">
  <script src="frontend.js"></script>
  <script src="backend.js"></script>

  <!--script src="https://js.stripe.com/v3/"></script-->
</head>

<script>
  function onPageLoad() {
    if (!Backend.isLogged()) {
      window.location = "/"
    }

    conversionRateElement = document.getElementById("DashboardAddFundsConversionRate")
    conversionRateElement.innerHTML = Backend.getAccount().payment.conversion_rate + " руб/доллар"

    initCardPanel()
  }

  function initCardPanel() {
    account = Backend.getAccount()
    if (account.card != null) {
      document.getElementById("DashboardCardStab").style.display = "none"
      document.getElementById("DashboardCard").style.display = "block"

      document.getElementById("DashboardCardNumberLabel").innerHTML = account.card.number
      document.getElementById("DashboardCardInscriptionLabel").innerHTML = account.card.first_name + " " + account.card.last_name
      document.getElementById("DashboardCardExpirationValue").innerHTML = account.card.expiration
      document.getElementById("DashboardCardCurrentFundsValue").innerHTML = "$" + account.card.balance
    } else {
      document.getElementById("DashboardCardStab").style.display = "block"
      document.getElementById("DashboardCard").style.display = "none"
    }
  }

  function performLogout() {
    Backend.logOut(function() {
      window.location="welcome.html"
    })
  }

  function performCardOrdering() {
    document.getElementById("DashboardCardStabOrderStatus").innerHTML = "Обрабатываю запрос"

    firstName = document.getElementById("DashboardCardStabFirstNameInput").value
    lastName = document.getElementById("DashboardCardStabLastNameInput").value
    Backend.orderCard(firstName, lastName, function(status) {
      if (status == BACKEND_CODE_SUCCESS) {
        initCardPanel()
        document.getElementById("DashboardCardStab").style.display = "none"
        document.getElementById("DashboardCard").style.display = "block"
      } else {
        document.getElementById("DashboardCardStabOrderStatus").innerHTML = "Не получилось запросить карту"
      }
    })
  }

  function validateAddFunds() {
    fundsValidator = function(value) {
      if (value == "") {
        return false
      }

      funds = parseInt(value)
      return funds > 0 && funds <= 100000
    }

    isValid = Frontend.validateInputField("DashboardAddFundsInput", fundsValidator)
    Frontend.setElementEnabled("DashboardAddFundsButton", isValid)

    value = document.getElementById("DashboardAddFundsInput").value
    funds = parseInt(value)
    dollarValue = "-"
    if (isValid) {
      dollarValue = funds / Backend.getAccount().payment.conversion_rate
      document.getElementById("DashboardAddFundsInDollarsValue").innerHTML = "$" + dollarValue
    } else {
      document.getElementById("DashboardAddFundsInDollarsValue").innerHTML = value == "" ? "$0" : "-"
    }
  }


  function validateCardOrdering() {
    nameValidator = function(name) {
      return name != "" && name.toLowerCase().match(
        /^([a-z])+$/
      ) != null
    }
    
    firstNameValid = Frontend.validateInputField("DashboardCardStabFirstNameInput", nameValidator)
    lastNameValid = Frontend.validateInputField("DashboardCardStabLastNameInput", nameValidator)

    Frontend.setElementEnabled("DashboardCardStabOrderButton", firstNameValid && lastNameValid)
  }
</script>

<body onload="onPageLoad()">
  <div id="PayrusHeader">
    <div id="PayrusLeftSideHeaderMenu">
        <div class="payrus-header-menu-item selected" onclick="window.location='dashboard.html'">Мой Эккаунт</div>
      </div>
      <div id="PayrusRightSideHeaderMenu">
        <div class="payrus-header-menu-item" onclick="window.location='profile.html'">Настройки Профиля</div>
        <div class="payrus-header-menu-item" onclick="performLogout()">Выйти</div>
      </div>
    </div>

  <div id="PayrusPageMainArea">
    <img id="PayrusLogo" src="imgs/payrus.png">
    <div id="DashboardPanel">
      <div id="DashboardCardPanel">
        <div id="DashboardCardStab">
          <label id="DashboardCardStabLogoLabel">Payment Bridge Services</label>
          <input id="DashboardCardStabFirstNameInput" type="text" placeholder="Имя (латинницей)" oninput="validateCardOrdering()">
          <input id="DashboardCardStabLastNameInput" type="text" placeholder="Фамилия (латинницей)" oninput="validateCardOrdering()">
          <button id="DashboardCardStabOrderButton" disabled onclick="performCardOrdering()">Заказать карту</button>
          <label id="DashboardCardStabOrderStatus"></label>
        </div>
        <div id="DashboardCard">
          <div id="DashboardCardCurrentFundsPanel">
            <label id="DashboardCardCurrentFundsLabel">Доступно:</label>
            <label id="DashboardCardCurrentFundsValue">$0</label>  
          </div>
          <label id="DashboardCardLogoLabel">Payment Bridge Services</label>
          <label id="DashboardCardNumberLabel"></label>
          <label id="DashboardCardInscriptionLabel"></label>
          <div id="DashboardCardExpirationPanel">
            <label id="DashboardCardExpirationLabel">Expires:</label>
            <label id="DashboardCardExpirationValue"></label>
          </div>
        </div>
        <div id="DashboardCardManagement">
          <a id="DashboardCardLostLink" href="card_lost.html">Я потерял карту</a>
          <a id="DashboardCardReplaceLink" href="card_lost.html">Заказать замену</a>
        </div>
        <div id="DashboardCardTransactionsPanel">
          История по карте:
        </div>
      </div>
      <div id="DashboardFundsPanel">
        <div id="DashboardAddFundsPanel">
          <label id="DashboardAddFundsLabel">Увеличить лимит расходования</label>
          <div>
            <input id="DashboardAddFundsInput" type="number" placeholder="Сумма в рублях" oninput="validateAddFunds()">
            <div id="DashboardAddFundsConversionPanel">
              <div>
                <label id="DashboardAddFundsInDollarsLabel">В долларовом эквиваленте:</label>
                <label id="DashboardAddFundsInDollarsValue">$0</label>
              </div>
              <div>
                <label id="DashboardAddFundsConversionLabel">Курс конвертации:</label>
                <label id="DashboardAddFundsConversionRate"></label>
              </div>
            </div>
            <label id="DashboardAddFundsLimitLabel">Не более 100,000 рублей за транзакцию</label>
          </div>
          <button id="DashboardAddFundsButton" disabled onclick="performFundsRequest()">Оплатить</button>
          <hr>
          <label id="DashboardQRCodeLabel">Отсканируйте QR-код для оплаты</label>
          <div id="DashboardAddFundsQRCode"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="PayrusFooter">
      PizTec Corporation, 2024.&nbsp;&nbsp;&nbsp;All Rights Reserved. 
  </div>
</body>
</html>
